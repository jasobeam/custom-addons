<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Un solo template que hace todas las modificaciones -->
        <template id="portal_project_tasks_list_inherit"
                  inherit_id="project.portal_tasks_list"
                  name="Portal Project Tasks List Inherit">

            <!-- Agregar botón del calendario -->
            <xpath expr="//thead" position="before">
                <div class="d-flex justify-content-end mb-2" t-if="project">
                    <a t-attf-href="/my/projects/#{project.id}/calendar"
                       class="btn btn-primary">
                        📅 Ver Calendario
                    </a>
                </div>
            </xpath>

            <!-- Reemplazar TODO el thead -->
            <xpath expr="//thead" position="replace">
                <thead>
                    <tr>
                        <!-- Allows overrides in modules -->
                        <t t-set="group_by_in_header_list"
                           t-value="['priority', 'state', 'project_id', 'stage_id', 'milestone_id']"/>
                        <t t-set="number_of_header" t-value="9"/>
                        <!-- Computes the right colspan once and use it everywhere -->
                        <t t-set="grouped_tasks_colspan"
                           t-value="number_of_header - 1 if groupby in group_by_in_header_list else number_of_header"/>
                        <t t-set="grouped_tasks_colspan"
                           t-value="grouped_tasks_colspan if allow_milestone else grouped_tasks_colspan - 1"/>
                        <th t-attf-colspan="{{2 if groupby != 'priority' else 1}}"/>
                        <th>Nombre</th>
                        <!-- 👇 nuevas columnas -->
                        <th>Fecha de Publicación</th>
                        <th>Estado de Publicación</th>
                        <!-- 👇 resto de columnas estándar -->
                        <th t-if="groupby != 'project_id' and multiple_projects">Project</th>
                        <th t-if="groupby != 'milestone_id' and allow_milestone"
                            name="project_portal_milestones">Milestone
                        </th>
                        <th t-if="groupby != 'state'">Estado</th>
                        <th t-if="groupby != 'stage_id'" class="text-end">Etapa</th>
                    </tr>
                </thead>
            </xpath>
            <!-- Quitar columna Assignees -->
            <xpath expr="//td[div[@t-if='assignees']]" position="replace"/>

            <!-- Agregar columnas nuevas después del nombre -->
            <xpath expr="//tr/td[a/span[@t-field='task.name']]" position="after">
                <td>
                    <span t-field="task.fecha_publicacion"/>
                </td>
                <td>
                    <span t-field="task.post_estado"/>
                </td>
            </xpath>
        </template>
        <!-- Herencia de la vista de detalle de tarea en el portal -->
        <template id="portal_my_task_inherit"
                  inherit_id="project.portal_my_task"
                  name="Portal Task Detail Inherit">

            <!-- Agregar hashtags y texto_en_diseno debajo de la descripción -->
            <xpath expr="//div[@id='card_body']//div[hasclass('row') and @t-if='task.description or task.attachment_ids']"
                   position="after">
                <div class="row" t-if="task.hashtags or task.texto_en_diseno">
                    <!-- Campo hashtags -->
                    <div t-if="task.hashtags" class="mb-4">
                        <h5 class="mb-1">Hashtags</h5>
                        <hr class="mt-1 mb-2"/>
                        <div class="py-1 px-2 bg-100 small overflow-auto table-responsive mb-4">
                            <span t-field="task.hashtags"/>
                        </div>
                    </div>

                    <!-- Campo texto_en_diseno -->
                    <div t-if="task.texto_en_diseno" class="mb-4">
                        <h5 class="mb-1">Texto en Diseño</h5>
                        <hr class="mt-1 mb-2"/>
                        <div class="py-1 px-2 bg-100 small overflow-auto table-responsive mb-4">
                            <span t-field="task.texto_en_diseno"/>
                        </div>
                    </div>
                </div>
            </xpath>

            <!-- ❌ Quitar el chatter (Communication history) -->
            <xpath expr="//div[@id='task_chat']" position="replace"/>

            <!-- 🔄 Reemplazar bloque de attachments para preview de imágenes y videos -->
            <xpath expr="//div[hasclass('o_project_portal_attachments')]" position="replace">
                <div t-if="task.attachment_ids" class="o_project_portal_attachments">
                    <h5 class="mb-1">Adjuntos</h5>
                    <hr class="mt-1 mb-2"/>
                    <div class="row">
                        <t t-foreach="task.attachment_ids" t-as="attachment">
                            <div class="col-12 col-md-4 mb-3">
                                <!-- Mostrar imágenes -->
                                <t t-if="'image' in (attachment.mimetype or '')">
                                    <img class="img-fluid rounded border"
                                         t-att-alt="attachment.name"
                                         t-att-src="'/web/content/%s?access_token=%s' % (attachment.id, attachment.access_token)"/>
                                </t>

                                <!-- Mostrar videos -->
                                <t t-elif="'video' in (attachment.mimetype or '')">
                                    <video class="w-100 rounded border" controls="controls">
                                        <source t-att-src="'/web/content/%s?access_token=%s' % (attachment.id, attachment.access_token)"
                                                t-att-type="attachment.mimetype"/>
                                        Tu navegador no soporta video.
                                    </video>
                                </t>

                                <!-- Otros archivos: dejar enlace -->
                                <t t-else="">
                                    <a t-att-href="'/web/content/%s?access_token=%s' % (attachment.id, attachment.access_token)"
                                       target="_blank">
                                        <i class="fa fa-paperclip me-2"/>
                                        <t t-esc="attachment.name"/>
                                    </a>
                                </t>
                            </div>
                        </t>
                    </div>
                </div>
            </xpath>
        </template>
    </data>
</odoo>